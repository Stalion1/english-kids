<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>English Kids</title>

<style>
:root{
  --blue:#4a6cf7; --purple:#7b5cff; --pink:#ff4fa3; --mint:#22c55e; --yellow:#ffd54a;
  --ink:#1f2937; --card:rgba(255,255,255,.92);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Arial Rounded MT Bold", Arial, sans-serif;
  color:var(--ink);
  text-align:center;
  background:
    radial-gradient(900px 420px at 12% 10%, #fff7d6 0%, transparent 55%),
    radial-gradient(900px 420px at 88% 25%, #dff7ff 0%, transparent 55%),
    radial-gradient(900px 420px at 60% 92%, #f7dcff 0%, transparent 55%),
    linear-gradient(135deg, #ffe7d2, #f7b9ff 45%, #bfe8ff);
  min-height:100vh;
}
header{
  position:sticky; top:0; z-index:10;
  color:#fff;
  padding:14px 12px;
  font-size:22px;
  font-weight:1000;
  background: linear-gradient(90deg,var(--blue),var(--purple));
  box-shadow:0 10px 24px rgba(0,0,0,.18);
}
.header-row{
  max-width:560px;margin:0 auto;
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(255,255,255,.18);
  border:2px solid rgba(255,255,255,.22);
  padding:6px 10px;border-radius:999px;
  font-size:13px;font-weight:1000;
  backdrop-filter: blur(6px);
}
.pill button{
  border:none;border-radius:999px;
  padding:8px 10px;font-size:13px;font-weight:1000;
  background: linear-gradient(135deg,#ffd54a,#ffe98a);
  color:#5a3b00;
  box-shadow:none;
}
.pill button:active{ transform:scale(.98); }

section{max-width:560px;margin:0 auto;padding:18px;}
.card{
  background:var(--card);border-radius:18px;padding:18px;margin-bottom:18px;
  box-shadow:0 14px 30px rgba(0,0,0,.14);
  border:2px solid rgba(255,255,255,.6);
  animation: cardIn .24s ease-out;
}
@keyframes cardIn{ from{transform:translateY(6px);opacity:.92} to{transform:translateY(0);opacity:1} }
h2{margin:0 0 10px;font-size:20px;font-weight:1000;}

#pic{
  width:230px;height:230px;border-radius:18px;background:#fff;
  border:3px solid rgba(74,108,247,.18);
  box-shadow:0 16px 28px rgba(0,0,0,.16);
  object-fit:contain;
  padding:18px;
}
.wiggle{ animation: wiggle .30s ease-out; }
@keyframes wiggle{
  0%{ transform: rotate(0deg) scale(1); }
  35%{ transform: rotate(-3deg) scale(1.02); }
  70%{ transform: rotate(3deg) scale(1.02); }
  100%{ transform: rotate(0deg) scale(1); }
}

.word{ font-size:34px;font-weight:1000;letter-spacing:2px;margin-top:10px; }
.wordGlow{ animation: glow .45s ease-out; }
@keyframes glow{
  0%{ text-shadow:0 0 0 rgba(74,108,247,0); transform: scale(1); }
  55%{ text-shadow:0 0 18px rgba(74,108,247,.35); transform: scale(1.05); }
  100%{ text-shadow:0 2px 0 rgba(255,255,255,.8); transform: scale(1); }
}

.row{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:12px;}
button.big{
  border:none;border-radius:16px;padding:14px 18px;font-size:18px;font-weight:1000;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
  box-shadow:0 10px 18px rgba(0,0,0,.14);
}
button.big:active{ transform: scale(.98); }
.btn-blue{ background: linear-gradient(135deg,var(--blue),var(--purple)); color:#fff; }
.btn-pink{ background: linear-gradient(135deg,var(--pink),#ff86c9); color:#fff; }
.btn-yellow{ background: linear-gradient(135deg,var(--yellow),#ffe98a); color:#5a3b00; }
.btn-mint{ background: linear-gradient(135deg,var(--mint),#86efac); color:#064; }
.btn-ghost{ background: rgba(255,255,255,.7); color:#1f2937; border:2px solid rgba(31,41,55,.08); }

.small-note{ margin-top:10px; font-size:13px; font-weight:900; opacity:.78; }

/* Locked UI */
.locked{ opacity:.55; filter:grayscale(.15); }
.locked button, .locked canvas{ pointer-events:none; }

/* Canvas */
canvas{
  width:330px;height:220px;border-radius:16px;
  border:3px solid rgba(74,108,247,.25);background:#fff;touch-action:none;
  box-shadow: inset 0 0 0 2px rgba(74,108,247,.08);
}

/* Toast */
#toast{
  position:fixed;left:50%;bottom:18px;
  transform: translateX(-50%) translateY(10px);
  background:rgba(17,24,39,.92);color:#fff;
  padding:10px 14px;border-radius:999px;
  font-weight:1000;font-size:14px;
  opacity:0;pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
  z-index:999;
}
#toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

/* FX layer */
#fx{ position:fixed; inset:0; pointer-events:none; z-index:998; }
.fx{
  position:absolute;
  font-size:30px;
  animation: floatUp .85s ease-out forwards;
  filter: drop-shadow(0 10px 10px rgba(0,0,0,.18));
}
@keyframes floatUp{
  0%{ transform: translate(-50%,-50%) scale(.7) rotate(-8deg); opacity:0; }
  20%{ opacity:1; }
  60%{ transform: translate(-50%,-90px) scale(1.15) rotate(8deg); }
  100%{ transform: translate(-50%,-130px) scale(.95) rotate(0deg); opacity:0; }
}

/* Lock overlay */
#lock{
  display:none;
  position:fixed; inset:0;
  background: rgba(0,0,0,.45);
  z-index:1000;
  padding:18px;
}
#lock .panel{
  max-width:520px;margin:20vh auto 0;
  background:rgba(255,255,255,.96);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
}
#lock h3{ margin:0 0 8px; font-size:20px; }
#lock p{ margin:0 0 14px; font-weight:900; color:#334155; }
</style>
</head>

<body>
<header>
  <div class="header-row">
    <div>üåà English Kids</div>
    <div class="pill">üß© L<span id="levelNum">1</span> ‚Ä¢ <span id="lvlInfo">1/1</span></div>
    <div class="pill">‚≠ê <span id="stars">0</span> <button id="resetStars" type="button">Reset</button></div>
    <div class="pill">Build: <span id="buildTag">choices-trace-v1</span></div>
  </div>
</header>

<div id="fx"></div>
<div id="toast">Nice!</div>

<div id="lock">
  <div class="panel">
    <h3>üîí Level Locked</h3>
    <p>Earn <span id="needStars">0</span> total ‚≠ê to unlock!</p>
    <button class="big btn-blue" id="closeLock" type="button">OK</button>
  </div>
</div>

<section>
  <div class="card">
    <h2>üëÄ Look</h2>
    <img id="pic" src="" alt="Picture" />
    <div class="small-note">Look at the picture üëÜ</div>
  </div>

  <div class="card">
    <h2>ü§î Choose the word</h2>
    <div id="masked" class="word">_ _ _</div>
    <div class="row" id="choicesRow"></div>
    <div class="small-note" id="choiceHint">Pick the matching word ‚úÖ</div>
  </div>

  <div class="card" id="sayCard">
    <h2>üó£Ô∏è Say</h2>
    <div class="row">
      <button class="big btn-blue" id="sayBtn" type="button">Say the word üîä</button>
    </div>
    <div class="small-note">Unlock by choosing the right word</div>
  </div>

  <div class="card" id="writeCard">
    <h2>‚úçÔ∏è Trace & Write</h2>
    <canvas id="draw" width="330" height="220"></canvas><br><br>
    <div class="row">
      <button class="big btn-pink" id="clearBtn" type="button">Clear ‚ú®</button>
      <button class="big btn-yellow" id="checkTraceBtn" type="button">Check Trace ‚úÖ</button>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="big btn-mint" id="nextLevelBtn" type="button">Next Level ‚û°Ô∏è</button>
    </div>

    <div class="small-note">Trace the dotted word, then tap ‚ÄúCheck Trace ‚úÖ‚Äù</div>
  </div>
</section>

<script>
/* Twemoji via jsDelivr */
const T = (hex) => `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/${hex}.png`;

/* Bigger Level 1 (more playability) */
const LEVELS = [
  { unlockStars: 0, lessons: [
    { word:"CAT",  say:"cat",  img:T("1f63a") },
    { word:"DOG",  say:"dog",  img:T("1f436") },
    { word:"COW",  say:"cow",  img:T("1f42e") },
    { word:"PIG",  say:"pig",  img:T("1f437") },
    { word:"FROG", say:"frog", img:T("1f438") },
    { word:"BIRD", say:"bird", img:T("1f426") },
    { word:"FISH", say:"fish", img:T("1f41f") },
    { word:"BEAR", say:"bear", img:T("1f43b") },
    { word:"LION", say:"lion", img:T("1f981") },
    { word:"DUCK", say:"duck", img:T("1f986") },
    { word:"BALL", say:"ball", img:T("26bd") },
    { word:"BOOK", say:"book", img:T("1f4d6") },
    { word:"CAKE", say:"cake", img:T("1f370") },
    { word:"MILK", say:"milk", img:T("1f95b") },
    { word:"RICE", say:"rice", img:T("1f35a") },
    { word:"TACO", say:"taco", img:T("1f32e") },
    { word:"CAR",  say:"car",  img:T("1f697") },
    { word:"BUS",  say:"bus",  img:T("1f68c") },
    { word:"BIKE", say:"bike", img:T("1f6b2") },
    { word:"HAT",  say:"hat",  img:T("1f3a9") },
    { word:"SOCK", say:"sock", img:T("1f9e6") },
    { word:"TREE", say:"tree", img:T("1f333") },
    { word:"STAR", say:"star", img:T("2b50") },
    { word:"MOON", say:"moon", img:T("1f319") },
    { word:"EGG",  say:"egg",  img:T("1f95a") },
    { word:"CUP",  say:"cup",  img:T("2615") },
    { word:"KEY",  say:"key",  img:T("1f511") },
    { word:"DRUM", say:"drum", img:T("1f941") }
  ]},
  { unlockStars: 25, lessons: [
    { word:"ANT",  say:"ant",  img:T("1f41c") },
    { word:"BEE",  say:"bee",  img:T("1f41d") },
    { word:"OWL",  say:"owl",  img:T("1f989") },
    { word:"FOX",  say:"fox",  img:T("1f98a") },
    { word:"WOLF", say:"wolf", img:T("1f43a") },
    { word:"GOAT", say:"goat", img:T("1f410") },
    { word:"DEER", say:"deer", img:T("1f98c") },
    { word:"CRAB", say:"crab", img:T("1f980") },
    { word:"PEAR", say:"pear", img:T("1f350") },
    { word:"KIWI", say:"kiwi", img:T("1f95d") },
    { word:"CORN", say:"corn", img:T("1f33d") },
    { word:"SOUP", say:"soup", img:T("1f372") },
    { word:"SODA", say:"soda", img:T("1f964") },
    { word:"HOME", say:"home", img:T("1f3e0") },
    { word:"SHIP", say:"ship", img:T("1f6a2") },
    { word:"BOAT", say:"boat", img:T("26f5") },
    { word:"BELL", say:"bell", img:T("1f514") },
    { word:"GAME", say:"game", img:T("1f3ae") },
    { word:"FIRE", say:"fire", img:T("1f525") }
  ]}
];

// ===== UI refs
const pic = document.getElementById("pic");
const masked = document.getElementById("masked");
const choicesRow = document.getElementById("choicesRow");
const choiceHint = document.getElementById("choiceHint");

const toast = document.getElementById("toast");
const fx = document.getElementById("fx");
const levelNumEl = document.getElementById("levelNum");
const lvlInfoEl = document.getElementById("lvlInfo");

const sayCard = document.getElementById("sayCard");
const writeCard = document.getElementById("writeCard");
const sayBtn = document.getElementById("sayBtn");
const clearBtn = document.getElementById("clearBtn");
const checkTraceBtn = document.getElementById("checkTraceBtn");
const nextLevelBtn = document.getElementById("nextLevelBtn");

const lock = document.getElementById("lock");
const needStarsEl = document.getElementById("needStars");
document.getElementById("closeLock").addEventListener("click", ()=> lock.style.display="none");

// ===== Helpers
function showToast(text){
  toast.textContent = text;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 900);
}
function wigglePic(){ pic.classList.remove("wiggle"); void pic.offsetWidth; pic.classList.add("wiggle"); }
function glowWord(){ masked.classList.remove("wordGlow"); void masked.offsetWidth; masked.classList.add("wordGlow"); }

function burst(x,y,emoji,count){
  const n = Math.min(7, Math.max(3,count));
  for(let k=0;k<n;k++){
    const e = document.createElement("div");
    e.className="fx";
    e.textContent=emoji;
    e.style.left = (x + (Math.random()*60-30)) + "px";
    e.style.top  = (y + (Math.random()*24-12)) + "px";
    fx.appendChild(e);
    setTimeout(()=>e.remove(), 900);
  }
}
function centerOf(el){
  const r = el.getBoundingClientRect();
  return {x:r.left + r.width/2, y:r.top + r.height/2};
}

// ===== Saved state
const STAR_KEY = "ek_stars_v5";
const LEVEL_KEY = "ek_level_v4";
let stars = Number(localStorage.getItem(STAR_KEY) || "0");
let level = Math.max(0, Math.min(LEVELS.length-1, Number(localStorage.getItem(LEVEL_KEY) || "0")));
let idx = 0;

// Stars UI
const starsEl = document.getElementById("stars");
function paintStars(){ starsEl.textContent = String(stars); }
paintStars();

function addStars(n, anchorEl){
  stars += n;
  localStorage.setItem(STAR_KEY, String(stars));
  paintStars();
  const c = anchorEl ? centerOf(anchorEl) : {x:window.innerWidth/2, y:80};
  burst(c.x,c.y,"‚≠ê",n+2);
}
document.getElementById("resetStars").addEventListener("click", ()=>{
  stars = 0;
  localStorage.setItem(STAR_KEY, "0");
  paintStars();
  showToast("Stars reset!");
});

// ===== Lesson state (locked until correct choice)
let unlocked = false;

function canUseLevel(lv){ return stars >= LEVELS[lv].unlockStars; }
function updateLevelPill(){
  levelNumEl.textContent = String(level+1);
  const total = LEVELS[level].lessons.length;
  lvlInfoEl.textContent = `${idx+1}/${total}`;
}
function getLesson(){ return LEVELS[level].lessons[idx]; }

function maskWord(w){
  // show underscores like "_ _ _" or "_ _ _ _"
  return w.split("").map(()=>"_").join(" ");
}

function setLockedUI(isLocked){
  if(isLocked){
    sayCard.classList.add("locked");
    writeCard.classList.add("locked");
  }else{
    sayCard.classList.remove("locked");
    writeCard.classList.remove("locked");
  }
}

// ===== Choices
function uniqueWordsPool(){
  return LEVELS[level].lessons.map(x=>x.word);
}
function buildChoices(correctWord){
  const pool = uniqueWordsPool().filter(w=>w !== correctWord);
  // pick 3 random distractors
  const picks = [];
  while(picks.length < 3 && pool.length){
    const j = Math.floor(Math.random()*pool.length);
    picks.push(pool.splice(j,1)[0]);
  }
  const all = [correctWord, ...picks];
  // shuffle
  for(let k=all.length-1;k>0;k--){
    const j = Math.floor(Math.random()*(k+1));
    [all[k], all[j]] = [all[j], all[k]];
  }
  return all;
}

function renderChoices(){
  const L = getLesson();
  choicesRow.innerHTML = "";
  const choices = buildChoices(L.word);
  choices.forEach(w=>{
    const b = document.createElement("button");
    b.className = "big btn-ghost";
    b.type = "button";
    b.textContent = w;
    b.addEventListener("click", ()=> chooseWord(w, b));
    choicesRow.appendChild(b);
  });
}

function chooseWord(wordPicked, btn){
  const L = getLesson();
  if(wordPicked === L.word){
    unlocked = true;
    masked.textContent = L.word; // reveal
    glowWord();
    setLockedUI(false);
    choiceHint.textContent = "Correct! üéâ Now you can Say and Trace!";
    addStars(2, btn);
    const c = centerOf(btn);
    burst(c.x,c.y,"üéâ",6);
    showToast("Correct! ‚≠ê +2");
    drawGuide(); // show dotted word
  }else{
    showToast("Try again üòä");
    const c = centerOf(btn);
    burst(c.x,c.y,"üí´",3);
  }
}

// ===== Render lesson
function renderLesson(){
  const L = getLesson();
  unlocked = false;
  setLockedUI(true);

  pic.src = L.img;
  pic.alt = L.word;
  masked.textContent = maskWord(L.word);
  choiceHint.textContent = "Pick the matching word ‚úÖ";
  renderChoices();
  updateLevelPill();

  clearUserInk();
  drawGuide(); // guide is shown even when locked (so they see what they'll trace)
  // But user can't draw until unlocked due to locked class pointer-events.
}

function randomLesson(){
  idx = Math.floor(Math.random() * LEVELS[level].lessons.length);
  renderLesson();
  wigglePic();
  showToast("New picture!");
}

// ===== Say
sayBtn.addEventListener("click", ()=>{
  if(!unlocked){ showToast("Pick the right word first üòä"); return; }
  const L = getLesson();
  const u = new SpeechSynthesisUtterance(L.say);
  u.rate = 0.82;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
  addStars(1, sayBtn);
  showToast("Nice saying! ‚≠ê +1");
});

// ===== Next Level
function nextLevel(){
  const next = level + 1;
  if(next >= LEVELS.length){ showToast("Max level!"); return; }
  if(!canUseLevel(next)){
    needStarsEl.textContent = String(LEVELS[next].unlockStars);
    lock.style.display = "block";
    return;
  }
  level = next;
  idx = 0;
  localStorage.setItem(LEVEL_KEY, String(level));
  renderLesson();
  showToast("Level up! üß©");
}
nextLevelBtn.addEventListener("click", nextLevel);

// ===== Random button (top)
document.getElementById("randomBtn").addEventListener("click", ()=>{
  randomLesson();
  addStars(1, document.getElementById("randomBtn"));
});

// ===== Canvas drawing + dotted guide + trace check
const canvas = document.getElementById("draw");
const ctx = canvas.getContext("2d");

// Offscreen for guide scoring
const guideCanvas = document.createElement("canvas");
guideCanvas.width = canvas.width;
guideCanvas.height = canvas.height;
const gctx = guideCanvas.getContext("2d");

function clearUserInk(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // re-draw guide after clearing ink
  drawGuide();
}

function drawGuide(){
  // draw guide on both canvases (main + offscreen) as faint dotted word
  const L = getLesson();
  const text = L.word;

  // guide settings
  const fontSize = 64;
  const font = `900 ${fontSize}px Arial, system-ui, sans-serif`;

  // Clear guide buffers
  gctx.clearRect(0,0,guideCanvas.width,guideCanvas.height);

  // MAIN: keep existing user ink; just draw guide underneath by redrawing whole thing:
  // We'll redraw guide on main AFTER user ink clears; if user already drew, we keep it simple:
  // draw a faint guide over the background (still okay).
  // (If you want guide strictly under ink later, we can do two-layer canvases.)
  // Draw guide on main:
  // First: do nothing special, just draw faint dashed stroke text.
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.lineWidth = 2.5;
  ctx.setLineDash([6, 8]);
  ctx.font = font;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.strokeStyle = "#4a6cf7";
  ctx.strokeText(text, canvas.width/2, canvas.height/2);
  ctx.restore();

  // Offscreen guide for scoring (solid, higher alpha)
  gctx.save();
  gctx.globalAlpha = 1;
  gctx.lineWidth = 6;
  gctx.setLineDash([6, 8]);
  gctx.font = font;
  gctx.textAlign = "center";
  gctx.textBaseline = "middle";
  gctx.strokeStyle = "#000";
  gctx.strokeText(text, guideCanvas.width/2, guideCanvas.height/2);
  gctx.restore();
}

// Drawing
ctx.lineWidth = 7;
ctx.lineCap = "round";
ctx.lineJoin = "round";
ctx.strokeStyle = "#111827";

let drawing = false;
canvas.addEventListener("pointerdown", e=>{
  if(!unlocked) return;
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("pointermove", e=>{
  if(!drawing || !unlocked) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup", ()=>drawing=false);
canvas.addEventListener("pointerleave", ()=>drawing=false);

clearBtn.addEventListener("click", ()=>{
  if(!unlocked){ showToast("Pick the right word first üòä"); return; }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGuide();
  addStars(1, clearBtn);
  showToast("Clear! ‚≠ê +1");
});

// Simple trace scoring: how many guide pixels have ink nearby
function checkTrace(){
  if(!unlocked){ showToast("Pick the right word first üòä"); return false; }

  // Get image data
  const user = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  const guide = gctx.getImageData(0,0,guideCanvas.width,guideCanvas.height).data;

  // Count guide pixels & overlapped pixels
  let guideCount = 0;
  let hitCount = 0;

  // Thresholds: guide is black in offscreen; user ink is dark in main.
  // Sample every 2 pixels for speed.
  const step = 8; // bigger = faster; still fine on iPhone
  for(let i=0; i<guide.length; i += 4*step){
    const g = guide[i]; // red channel of guide
    // guide pixel present if dark
    if(g < 30){
      guideCount++;
      const u = user[i]; // red channel of user
      if(u < 60) hitCount++;
    }
  }

  // Avoid divide by zero
  const ratio = guideCount ? (hitCount / guideCount) : 0;

  // Kid-friendly threshold (not strict)
  return ratio > 0.07; // ~7% overlap is enough for a reward
}

checkTraceBtn.addEventListener("click", ()=>{
  const ok = checkTrace();
  if(ok){
    addStars(3, checkTraceBtn);
    const c = centerOf(checkTraceBtn);
    burst(c.x,c.y,"üéâ",7);
    showToast("Great tracing! ‚≠ê +3");
  }else{
    showToast("Almost! Trace the dotted word üòä");
    const c = centerOf(checkTraceBtn);
    burst(c.x,c.y,"üí´",4);
  }
});

// Start
renderLesson();
</script>
</body>
</html>
